<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Protocol Buffer</title>
    <script src="axios.js"></script>
    <script src="long.js"></script>
    <script src="bytebuffer.js"></script>
    <script src="protobuf.js"></script>
</head>
<body>
<h1 style="width: 100%; text-align: center">Protocol Buffer Data Test!</h1>
<button style="outline: none; background: yellowgreen; color: wheat" onclick="uploadData()">上传数据</button>
</body>
<script>
    console.log("window: ", window);
    console.log("protobuf: ", protobuf);
    var personMessage = null;
    axios.get("../proto/get").then(function (value){
        var buffer =  value.data;
        console.log('data: ', buffer);
        console.log('buffer type: ', typeof buffer);
        // var buf = new dcodeIO.ByteBuffer().writeIString(buffer).flip()
        var buf = new dcodeIO.ByteBuffer.fromBase64(buffer)
        // var buf = Uint8Array.from(buffer);
        console.log('buffer object: ', buf);
        protobuf.load('../protos/person.proto').then(function (root) {
            console.log('root: ', root);
            personMessage = root.lookupType('com.etertops.protos.PersonMessage');
            console.log("pm: ", personMessage);
            var person = personMessage.decode(buf.view);
            console.log(person)
        });

    })
    function uploadData() {
        protobuf.load('../protos/person.proto').then(function (root) {
            console.log('root: ', root);
            personMessage = root.lookupType('com.etertops.protos.PersonMessage');
            var payload = {
                id: 'test id from html',
                name: 'protobuf.js',
                sex: '男',
                address: '中华人民共和国',
                age: '16',
                phone: 'made in china'
            };
            var errMsg = personMessage.verify(payload);
            var message = personMessage.create(payload);
            var buffer = personMessage.encode(message).finish();
            console.log('post buffer: ', buffer);
            var arr = new Uint8Array(buffer);
            console.log('post arr: ', arr);
            var fd = new FormData();
            var blob = new Blob(buffer, {type: "application/octet-stream"});
            fd.append('proto', buffer);
            console.log('blob', blob)
            axios.post('../proto/post', fd).then(function (value) {
                console.log(value)
            })
        });
    }
</script>
</html>